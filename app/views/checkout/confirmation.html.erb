<section class="pt-8">
  <div class="container mx-auto max-w-2xl px-4 py-8">
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
      <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-6 text-center">
        <h2 class="text-2xl md:text-3xl font-bold mb-1 flex items-center justify-center gap-2">
          <svg class="w-7 h-7 inline-block mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
          ชำระเงิน
        </h2>
        <p class="opacity-80">ออเดอร์ #<%= @order.order_number %></p>
      </div>

      <div class="px-8 py-6">
        <% if @order.awaiting_payment? %>
          <div class="text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-2">ยอดชำระทั้งสิ้น</h3>
            <p class="text-5xl font-bold text-primary-600 mb-6"><%= number_to_currency(@order.total_amount, unit: "฿") %></p>

            <div class="p-4 bg-gray-50 border rounded-lg mb-6">
              <p class="font-semibold">สแกน QR Code เพื่อชำระเงิน</p>
              <%# หมายเหตุ: ควรเปลี่ยนเบอร์โทรศัพท์/เลขบัญชีเป็นของคุณ %>
              <img src="https://promptpay.io/0812345678/<%= @order.total_amount %>.png" alt="QR Code" class="mx-auto my-4 w-48 h-48 border rounded-lg">
              <p class="text-sm"><strong>ชื่อบัญชี:</strong> บริษัท ไลฟ์ ซีเอฟ จำกัด</p>
              <p class="text-sm"><strong>ธนาคาร:</strong> กสิกรไทย</p>
            </div>

            <p class="text-gray-500 text-sm my-4">หลังจากโอนเงินเรียบร้อยแล้ว กรุณา **อัปโหลดสลิป** ด้านล่างนี้เพื่อยืนยัน</p>

            <form id="slip-payment-form" data-order-token="<%= @order.checkout_token %>">
              <input type="file" name="payment[slip]" id="slip-file-input" accept="image/*" required
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4">

              <button type="submit"
                      class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors text-lg">
                ✅ ยืนยันการชำระเงิน
              </button>
            </form>
            <div id="payment-status" class="mt-4"></div>

          </div>

        <% elsif @order.paid? || @order.confirmed? %>
          <%# ... ส่วนนี้ถูกต้องแล้ว ... %>
          <div class="text-center">
            <div class="mb-4">
              <svg class="w-16 h-16 text-green-500 mx-auto" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h3 class="text-2xl font-bold text-green-600 mb-3">ชำระเงินเรียบร้อยแล้ว!</h3>
            <p class="text-gray-700 mb-4">เราได้รับการยืนยันการชำระเงินของคุณแล้ว<br>
              ผู้ขายกำลังเตรียมจัดส่งสินค้าให้คุณ</p>
            <%= link_to "กลับสู่หน้าหลัก", root_path, class: "text-primary-600 hover:underline" %>
          </div>

        <% else %>
          <%# ... ส่วนนี้ถูกต้องแล้ว ... %>
          <div class="text-center">
            <p>สถานะออเดอร์ปัจจุบัน: <span class="font-bold"><%= @order.status.humanize %></span></p>
            <p class="text-gray-500 mt-2">ไม่สามารถดำเนินการต่อได้ในขณะนี้</p>
            <%= link_to "กลับสู่หน้าหลัก", root_path, class: "text-primary-600 hover:underline mt-4 inline-block" %>
          </div>
        <% end %>

      </div>
    </div>
  </div>
</section>

<script type="module">
  import QrScanner from "/js/qr-scanner.min.js";

  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('slip-upload-form');
    if (!form) return;

    const statusDiv = document.getElementById('upload-status');
    const orderToken = form.dataset.orderToken;
    const submitButton = form.querySelector('button[type="submit"]');
    const fileInput = document.getElementById('slip-file-input'); // <-- แก้ ID ให้ตรง

    // ฟังก์ชันสำหรับเรียก API
    function submitPaymentApi(formData) {
      statusDiv.innerHTML = '<p class="text-blue-600">กำลังยืนยันข้อมูลกับเซิร์ฟเวอร์...</p>';
      const apiUrl = `/api/v1/orders/${orderToken}/submit_payment`;
      const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");

      fetch(apiUrl, {
        method: 'POST',
        headers: {
          'X-CSRF-Token': csrfToken
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          statusDiv.innerHTML = `<p class="text-green-600">${data.message}</p>`;
          Swal.fire({ title: "สำเร็จ!", text: data.message, icon: "success" })
              .then(() => window.location.reload());
        } else {
          statusDiv.innerHTML = `<p class="text-red-600">เกิดข้อผิดพลาด: ${data.message}</p>`;
          submitButton.disabled = false;
          submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      })
      .catch(error => {
        statusDiv.innerHTML = `<p class="text-red-600">เกิดข้อผิดพลาดในการเชื่อมต่อ</p>`;
        submitButton.disabled = false;
        submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        console.error('Error:', error);
      });
    }

    // Event listener เมื่อกดปุ่ม Submit
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      const file = fileInput.files[0];

      if (!file) {
        statusDiv.innerHTML = '<p class="text-red-600">กรุณาเลือกไฟล์สลิปก่อน</p>';
        return;
      }

      submitButton.disabled = true;
      submitButton.classList.add('opacity-50', 'cursor-not-allowed');
      statusDiv.innerHTML = '<p class="text-blue-600">กำลังสแกน QR Code จากสลิป...</p>';

      QrScanner.scanImage(file, { returnDetailedScanResult: true })
        .then(result => {
          const qrDataString = result.data;
          if (!qrDataString) { throw new Error("ไม่พบ QR Code ในรูปภาพนี้"); }

          const sending_bank = qrDataString.substr(18, 3);
          const transaction_code = qrDataString.substr(25, qrDataString.length - 39);

          const formData = new FormData();
          formData.append('payment[slip]', file); // 1. แนบไฟล์
          formData.append('payment[sending_bank]', sending_bank); // 2. แนบข้อมูลที่สแกนได้
          formData.append('payment[transaction_code]', transaction_code); // 3. แนบข้อมูลที่สแกนได้

          // ส่ง FormData ไปที่ API
          submitPaymentApi(formData);
        })
        .catch(e => {
          statusDiv.innerHTML = `<p class="text-red-600">${e.message || 'ไม่สามารถสแกน QR Code ได้'}</p>`;
          submitButton.disabled = false;
          submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    });
  });
</script>